<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTA ¬∑ AGRORAC</title>

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel para JSX en el navegador -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-white text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // =========================================================
    // 1) Cat√°logo de cultivos / variantes (por ahora solo cacao)
    //    Para agregar m√°s, copia el bloque de cacao y ajusta URLs
    // =========================================================
    const CROPS = {
      cacao: {
        id: "cacao",
        nombre: "Cacao",
        variants: [
          {
            id: "general",
            nombre: "General",
            vegUrl:  "https://raw.githubusercontent.com/vvalencia1306-code/applet-Fenologia-Riesgos-Capsicum/main/vegetativa.csv",
            prodUrl: "https://raw.githubusercontent.com/vvalencia1306-code/applet-Fenologia-Riesgos-Capsicum/main/productiva.csv",
          },
        ],
      },

      // Ejemplos para el futuro (d√©jalos como referencia):
      // zanahoria: {
      //   id: "zanahoria",
      //   nombre: "Zanahoria",
      //   variants: [{ id: "general", nombre: "General", singleUrl: "https://.../zanahoria.csv" }],
      // },
      // capsicum: {
      //   id: "capsicum",
      //   nombre: "Capsicum (aj√≠/piment√≥n)",
      //   variants: [
      //     { id: "annuum",   nombre: "C. annuum",   singleUrl: "https://.../capsicum_annuum.csv" },
      //     { id: "baccatum", nombre: "C. baccatum", singleUrl: "https://.../capsicum_baccatum.csv" },
      //   ],
      // },
    };

    // =========================================================
    // 2) Hook de carga de CSV (soporta: singleUrl o veg+prod)
    // =========================================================
    function useCsvData({ vegUrl, prodUrl, singleUrl }) {
      const [veg, setVeg] = useState([]);
      const [prod, setProd] = useState([]);

      useEffect(() => {
        const normalizar = (rows) =>
          rows
            .filter(r => r.elem && r.elem.trim())
            .map(r => {
              const meses = (r.meses || "")
                .replace(/[\[\]\s]/g, "")
                .split(",")
                .filter(Boolean)
                .map(n => Number(n));
              return {
                elem: r.elem?.trim() || "",
                ini: r.ini ? Number(r.ini) : null,
                fin: r.fin ? Number(r.fin) : null,
                meses,
                riesgos: {
                  deficit: r.deficit || "",
                  exceso:  r.exceso  || "",
                  Tmax:    r.Tmax    || "",
                  Tmin:    r.Tmin    || "",
                },
                ref: r.ref || "",
              };
            });

        const cargar = (url, set) =>
          Papa.parse(url, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: ({ data }) => set(normalizar(data)),
          });

        // Caso: una sola ficha (p. ej., zanahoria)
        if (singleUrl) {
          cargar(singleUrl, setVeg); // tratamos como "veg"
          setProd([]);
          return;
        }

        // Caso: dos fases (veg/prod)
        if (vegUrl)  cargar(vegUrl,  setVeg);
        if (prodUrl) cargar(prodUrl, setProd);
      }, [vegUrl, prodUrl, singleUrl]);

      return { veg, prod };
    }

    // =========================================================
    // 3) Componentes: Intro, Picker (selector), Matriz, Detalle
    // =========================================================
    function Intro({ onStart }) {
      return (
        <div className="max-w-5xl mx-auto p-6">
          <h1 className="text-3xl font-semibold mb-10 text-center">
            ¬øQU√â ES UNA FICHA T√âCNICA AGROCLIM√ÅTICA (FTA)?
          </h1>

          <p className="text-gray-700 mb-6">
            Una FTA es un instrumento <b>t√©cnico</b> que organiza y sintetiza los principales{" "}
            <b>riesgos agroclim√°ticos</b> que afectan un sistema productivo. Identifica los{" "}
            <b>elementos expuestos</b> (ra√≠ces, tallo, floraci√≥n, pr√°cticas de manejo) y los relaciona
            con <b>amenazas clim√°ticas</b> como <i>d√©ficit y exceso h√≠drico</i> y{" "}
            <i>temperaturas extremas</i>. Facilita decisiones oportunas y <b>adaptativas</b>.
          </p>

          <div className="p-4 rounded-xl bg-amber-50 text-amber-900 mb-10">
            <b>Importante:</b> Los campos <i>Mes inicio</i> y <i>Mes fin</i> <b>no son meses de calendario</b>.
            ‚ÄúMes 1‚Äù es el primer mes del evento dentro del sistema productivo. Por ejemplo, puede coincidir con
            octubre si all√≠ inicia la preparaci√≥n del terreno.
          </div>

          <p className="text-gray-700 mb-12">
            Esta forma relativa de representar la temporalidad permite adaptar la ficha a ciclos productivos
            variables, evitando rigideces en fechas hist√≥ricas de siembra o manejo. As√≠, la FTA se convierte en
            una herramienta flexible y √∫til frente a la variabilidad y el cambio clim√°tico.
          </p>

          <div className="flex justify-center">
            <button
              onClick={onStart}
              className="px-5 py-3 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700"
            >
              üëâ Explorar fichas t√©cnicas
            </button>
          </div>
        </div>
      );
    }

    // Selector de cultivo / variante / fase (seg√∫n aplique)
    function Picker({ onConfirm }) {
      const cropIds = Object.keys(CROPS);
      const [cropId, setCropId] = useState(cropIds[0] || "");
      const crop = CROPS[cropId];

      const [variantId, setVariantId] = useState(crop?.variants?.[0]?.id || "");
      useEffect(() => {
        setVariantId(CROPS[cropId]?.variants?.[0]?.id || "");
      }, [cropId]);

      const variant = crop?.variants?.find(v => v.id === variantId);

      const hasVeg  = !!variant?.vegUrl || !!variant?.singleUrl;
      const hasProd = !!variant?.prodUrl;
      const fases   = hasVeg && hasProd ? ["Vegetativa", "Productiva"] : ["√önica"];

      const [fase, setFase] = useState(fases[0]);
      useEffect(() => {
        setFase(fases[0]);
      }, [variantId, cropId]);

      const handleGo = () => {
        // Empaquetamos lo necesario para cargar y mostrar
        const cfg = {
          cropId,
          cropName: crop.nombre,
          variantId,
          variantName: variant?.nombre || "General",
          fase, // "Vegetativa" | "Productiva" | "√önica"
          urls: {
            vegUrl:  variant?.vegUrl  || null,
            prodUrl: variant?.prodUrl || null,
            singleUrl: variant?.singleUrl || null,
          },
        };
        onConfirm(cfg);
      };

      return (
        <div className="max-w-3xl mx-auto p-6 space-y-6">
          <h2 className="text-2xl font-semibold">Selecciona la ficha a explorar</h2>

          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="text-sm text-gray-600">Sistema productivo</label>
              <select
                className="mt-1 w-full border rounded-lg px-3 py-2"
                value={cropId}
                onChange={e => setCropId(e.target.value)}
              >
                {cropIds.map(id => (
                  <option key={id} value={id}>{CROPS[id].nombre}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="text-sm text-gray-600">Variante / Especie</label>
              <select
                className="mt-1 w-full border rounded-lg px-3 py-2"
                value={variantId}
                onChange={e => setVariantId(e.target.value)}
              >
                {(crop?.variants || []).map(v => (
                  <option key={v.id} value={v.id}>{v.nombre}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="text-sm text-gray-600">Fase</label>
              <select
                className="mt-1 w-full border rounded-lg px-3 py-2"
                value={fase}
                onChange={e => setFase(e.target.value)}
                disabled={fases.length === 1}
              >
                {fases.map(f => (
                  <option key={f} value={f}>{f === "√önica" ? "√önica" : f}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="pt-2">
            <button
              onClick={handleGo}
              className="px-5 py-3 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700"
            >
              Continuar
            </button>
          </div>
        </div>
      );
    }

    function PanelDetalle({ fila, onClose }) {
      if (!fila) return null;
      const R = fila.riesgos || {};
      return (
        <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 flex">
          <div className="m-auto w-[95%] max-w-3xl bg-white rounded-2xl shadow-lg p-5">
            <div className="flex items-start justify-between gap-4">
              <h3 className="text-lg font-semibold">{fila.elem}</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>

            <p className="text-sm text-gray-600 mb-3">
              {fila.meses?.length
                ? <>Meses: {fila.meses.map(m => `M${m}`).join(", ")}</>
                : <>Ventana: M{fila.ini ?? "‚Äî"} ‚Äì M{fila.fin ?? "‚Äî"}</>}
            </p>

            <div className="grid md:grid-cols-2 gap-3 text-sm">
              <div className="border rounded-xl p-3"><b>D√©ficit h√≠drico:</b> {R.deficit || "‚Äî"}</div>
              <div className="border rounded-xl p-3"><b>Exceso h√≠drico:</b> {R.exceso || "‚Äî"}</div>
              <div className="border rounded-xl p-3"><b>Temperatura m√°xima:</b> {R.Tmax || "‚Äî"}</div>
              <div className="border rounded-xl p-3"><b>Temperatura m√≠nima:</b> {R.Tmin || "‚Äî"}</div>
            </div>
            <p className="text-xs text-gray-500 mt-4"><b>Referencias:</b> {fila.ref || "‚Äî"}</p>
          </div>
        </div>
      );
    }

    function Matriz({ onBack, title, fase, dataVeg, dataProd }) {
      // si hay dos fases, usamos el select; si no, ocultamos
      const hasTwoPhases = (dataVeg?.length || 0) > 0 && (dataProd?.length || 0) > 0;
      const [faseSel, setFaseSel] = useState(hasTwoPhases ? fase : "√önica");
      useEffect(() => {
        setFaseSel(hasTwoPhases ? fase : "√önica");
      }, [fase, hasTwoPhases]);

      const data = hasTwoPhases
        ? (faseSel === "Productiva" ? dataProd : dataVeg)
        : (dataVeg?.length ? dataVeg : dataProd);

      const maxMes = useMemo(() => {
        const filaMax = (r) =>
          Array.isArray(r?.meses) && r.meses.length ? Math.max(...r.meses) :
          (typeof r?.fin === "number" ? r.fin : 0);
        const vals = (data || []).map(filaMax);
        const max = vals.length ? Math.max(...vals) : 0;
        return max > 0 ? max : 22;
      }, [data]);

      const meses = useMemo(() => Array.from({ length: maxMes }, (_, i) => i + 1), [maxMes]);

      return (
        <div className="max-w-7xl mx-auto p-6 space-y-6">
          <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h1 className="text-2xl font-semibold">{title}</h1>
              <p className="text-sm text-gray-600">Los meses representan <b>fases del ciclo</b>.</p>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={onBack} className="px-3 py-2 border rounded-lg text-sm">‚Üê Volver</button>
              {hasTwoPhases && (
                <>
                  <label className="text-sm text-gray-600">Fase:</label>
                  <select
                    value={faseSel}
                    onChange={e => setFaseSel(e.target.value)}
                    className="border rounded-lg px-3 py-2 text-sm"
                  >
                    <option>Vegetativa</option>
                    <option>Productiva</option>
                  </select>
                </>
              )}
            </div>
          </header>

          <div className="overflow-auto border rounded-2xl">
            <table className="min-w-full text-sm">
              <thead>
                <tr className="bg-gray-50">
                  <th className="text-left px-3 py-2 sticky left-0 bg-gray-50 z-10">Elemento expuesto</th>
                  {meses.map(m => <th key={m} className="px-3 py-2 text-center border-l">M{m}</th>)}
                </tr>
              </thead>
              <tbody>
                {(data || []).map((row, i) => {
                  const activo = (m, r) => {
                    if (Array.isArray(r?.meses) && r.meses.length) return r.meses.includes(m);
                    return typeof r.ini === "number" && typeof r.fin === "number" && m >= r.ini && m <= r.fin;
                  };
                  return (
                    <tr key={i} className={i % 2 ? "bg-white" : "bg-gray-50/50 hover:bg-emerald-50"}>
                      <td className="px-3 py-2 sticky left-0 bg-inherit max-w-[360px]">{row.elem}</td>
                      {meses.map((m, j) => (
                        <td key={j} className={`h-9 border-l ${activo(m, row) ? "bg-emerald-200" : ""}`} />
                      ))}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <p className="text-xs text-gray-500">
            Haz clic en el nombre de la fila para ver el detalle y las referencias (funcionalidad opcional).
          </p>
        </div>
      );
    }

    // =========================================================
    // 4) App principal
    // =========================================================
    function App() {
      const [step, setStep] = useState("intro");    // intro | picker | matrix
      const [cfg, setCfg]   = useState(null);       // { cropName, variantName, fase, urls }

      // Carga de datos seg√∫n la selecci√≥n
      const { veg, prod } = useCsvData(cfg?.urls || {});

      // T√≠tulo din√°mico para la matriz
      const title = cfg
        ? `Matriz preliminar de riesgos agroclim√°ticos ¬∑ ${CROPS[cfg.cropId].nombre}` +
          (cfg.variantName ? ` (${cfg.variantName})` : "")
        : "Matriz";

      if (step === "intro") {
        return <Intro onStart={() => setStep("picker")} />;
      }

      if (step === "picker") {
        return (
          <Picker
            onConfirm={(selection) => {
              setCfg(selection);
              setStep("matrix");
            }}
          />
        );
      }

      // step === "matrix"
      return (
        <Matriz
          onBack={() => setStep("picker")}
          title={title}
          fase={cfg?.fase || "Vegetativa"}
          dataVeg={veg}
          dataProd={prod}
        />
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>

