<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FTA Cacao - AGRORAC</title>

  <!-- PapaParse para leer CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-white text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // ===========================
    // HOOK PARA CARGAR CSV
    // ===========================
    function useCsvData() {
      const [veg, setVeg] = useState([]);
      const [prod, setProd] = useState([]);

      useEffect(() => {
        const normalizar = (rows) =>
          rows
            .filter(r => r.elem && r.elem.trim())
            .map(r => {
              const meses = (r.meses || "")
                .replace(/[\[\]\s]/g, "")
                .split(",")
                .filter(Boolean)
                .map(n => Number(n));
              return {
                elem: r.elem?.trim() || "",
                ini: r.ini ? Number(r.ini) : null,
                fin: r.fin ? Number(r.fin) : null,
                meses,
                riesgos: {
                  deficit: r.deficit || "",
                  exceso: r.exceso || "",
                  Tmax: r.Tmax || "",
                  Tmin: r.Tmin || ""
                },
                ref: r.ref || ""
              };
            });

        const cargar = (url, set) =>
          Papa.parse(url, {
            download: true,
            header: true,
            // Si tus CSV usan ; y/o tienen acentos extra√±os, descomenta:
            // encoding: "ISO-8859-1",
            // delimiter: ";",
            skipEmptyLines: true,
            complete: ({ data }) => set(normalizar(data))
          });

        cargar("https://raw.githubusercontent.com/vvalencia1306-code/applet-Fenologia-Riesgos-Capsicum/main/vegetativa.csv", setVeg);
        cargar("https://raw.githubusercontent.com/vvalencia1306-code/applet-Fenologia-Riesgos-Capsicum/main/productiva.csv", setProd);
      }, []);

      return { veg, prod };
    }

    // ===========================
    // COMPONENTES
    // ===========================
    function Intro({ onStart }) {
      return (
         <div className="max-w-5xl mx-auto p-6 space-y-6">
      <header className="space-y-6">
        {/* Logo + t√≠tulo en fila */}
        <div className="flex items-center gap-4">
          <img 
            src="assets/Logo_Agrorac.png" 
            alt="Logo AGRORAC" 
            className="w-32"
          />
            <h1 className="text-3xl font-semibold mb-16 text-center">
              ¬øQU√â ES UNA FICHA T√âCNICA AGROCLIM√ÅTICA (FTA)?
            </h1>
          </div>

            <p className="text-gray-700 mb-10">
              Una FTA es un instrumento <b>t√©cnico</b> que organiza y sintetiza los principales
              <b> riesgos agroclim√°ticos</b> que afectan un sistema productivo agr√≠cola. Para ello,
              se identifican los <b>elementos expuestos</b> del cultivo (ra√≠ces, tallo, floraci√≥n,
              pr√°cticas de manejo) y se relacionan con <b>amenazas clim√°ticas</b> como
              <i> d√©ficit y exceso h√≠drico</i> y <i>temperaturas extremas</i>. Este instrumento
              permite la toma de decisiones oportunas y <b>adaptativas</b> por parte de los actores
              del sistema productivo con el fin de fortalecer la planificaci√≥n agr√≠cola.
            </p>

            <div className="p-4 rounded-xl bg-amber-50 text-amber-900 mb-16">
              <b>Importante:</b> Los campos <i>Mes inicio</i> y <i>Mes fin</i>
              <b> no son meses de calendario</b>. ‚ÄúMes 1‚Äù es el primer mes del evento dentro del
              sistema productivo. Por ejemplo, puede coincidir con octubre si all√≠ inicia la
              preparaci√≥n del terreno. Esto es clave porque las siembras ya no ocurren siempre en
              las mismas fechas hist√≥ricas.
            </div>

            <p className="text-gray-700 mb-16">
              Esta forma relativa de representar la temporalidad permite adaptar la ficha a ciclos
              productivos variables, evitando rigideces en fechas hist√≥ricas de siembra o manejo.
              As√≠, la FTA se convierte en una herramienta flexible y √∫til frente a la variabilidad
              y el cambio clim√°tico, facilitando su contextualizaci√≥n territorial.
            </p>
          </header>

          {/* Dos tarjetas: Componentes / P√∫blico objetivo */}
          <section className="grid md:grid-cols-2 gap-6">
            {/* Tarjeta 1 */}
            <div className="rounded-2xl border p-5">
              <h2 className="font-semibold mb-2">Componentes de la FTA</h2>
              <ul className="list-disc ml-6 text-gray-700 space-y-1">
                <li>
                  Filas ={" "}
                  <span className="relative group inline-block cursor-help">
                    <b>elementos expuestos</b>
                    <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-64 p-2 bg-blue-800 text-white text-xs rounded-lg shadow-lg">
                      Componentes espec√≠ficos del cultivo susceptibles al impacto de eventos clim√°ticos. 
                      Los elementos expuestos pueden corresponder tanto a fases fenol√≥gicas como a pr√°cticas de manejo.
                    </span>
                  </span>{" "}
                </li>

                <li>
                  Columnas ={" "}
                  <span className="relative group inline-block cursor-help">
                    <b>ventana de temporalidad</b>
                    <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-64 p-2 bg-blue-800 text-white text-xs rounded-lg shadow-lg">
                      Intervalos de tiempo dentro del ciclo productivo en los que se pueden presentar
                      riesgos agroclim√°ticos.
                    </span>
                  </span>{" "}
                  y{" "}
                  <span className="relative group inline-block cursor-help">
                    <b>amenazas clim√°ticas</b>
                    <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-64 p-2 bg-blue-800 text-white text-xs rounded-lg shadow-lg">
                      Condiciones externas al sistema productivo y fuera del control humano, con capacidad de generar efectos adversos sobre el cultivo (d√©ficit h√≠drico, exceso h√≠drico, temperaturas extremas).
                    </span>
                  </span>
                </li>
              </ul>
            </div>

            {/* Tarjeta 2 */}
            <div className="rounded-2xl border p-5">
              <h2 className="font-semibold mb-2">P√∫blico objetivo</h2>
              <p className="text-gray-700">
                Actores del territorio que tienen conocimiento directo, t√©cnico o pr√°ctico sobre los
                sistemas productivos priorizados. Su prop√≥sito es validar, complementar o ajustar las
                FTA preliminares y facilitar su apropiaci√≥n local.
              </p>
            </div>
          </section>

          {/* Imagen de apoyo */}
          <div className="mt-6 flex justify-center">
            <img
              src="assets/Dise√±oFTA.png"
              alt="Dise√±o FTA"
              className="rounded-xl shadow-lg max-w-2xl w-full"
            />
          </div>

          {/* Bot√≥n */}
          <div className="pt-2">
            <button
              onClick={onStart}
              className="px-5 py-3 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700"
            >
              üëâ Explorar matriz de cacao
            </button>
          </div>
        </div>
      );
    }

    function Pill({ children }) {
      return (
        <span className="px-2 py-0.5 rounded-full bg-gray-100 border text-gray-800 text-xs">
          {children}
        </span>
      );
    }

    function PanelDetalle({ fila, onClose }) {
      if (!fila) return null;
      const R = fila.riesgos || {};
      return (
        <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 flex">
          <div className="m-auto w-[95%] max-w-3xl bg-white rounded-2xl shadow-lg p-5">
            <div className="flex items-start justify-between gap-4">
              <h3 className="text-lg font-semibold">{fila.elem}</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>

            <p className="text-sm text-gray-600 mb-3">
              {fila.meses?.length
                ? <>Meses: {fila.meses.map(m => `M${m}`).join(", ")}</>
                : <>Ventana: M{fila.ini ?? "‚Äî"} ‚Äì M{fila.fin ?? "‚Äî"}</>}
            </p>

            <div className="grid md:grid-cols-2 gap-3 text-sm">
              <div className="border rounded-xl p-3"><b>D√©ficit h√≠drico:</b> {R.deficit || "‚Äî"}</div>
              <div className="border rounded-xl p-3"><b>Exceso h√≠drico:</b> {R.exceso || "‚Äî"}</div>
              <div className="border rounded-xl p-3"><b>Temperatura m√°xima:</b> {R.Tmax || "‚Äî"}</div>
              <div className="border rounded-xl p-3"><b>Temperatura m√≠nima:</b> {R.Tmin || "‚Äî"}</div>
            </div>

            <p className="text-xs text-gray-500 mt-4"><b>Referencias:</b> {fila.ref || "‚Äî"}</p>
          </div>
        </div>
      );
    }

    function MatrizCacao({ onBack, dataVeg, dataProd }) {
      const [fase, setFase] = useState("Vegetativa");
      const [sel, setSel] = useState(null);
      const data = fase === "Vegetativa" ? dataVeg : dataProd;

      const maxMes = useMemo(() => {
        const filaMax = (r) =>
          Array.isArray(r?.meses) && r.meses.length
            ? Math.max(...r.meses)
            : (typeof r?.fin === "number" ? r.fin : 0);
        const vals = data.map(filaMax);
        const max = vals.length ? Math.max(...vals) : 0;
        return max > 0 ? max : 22;
      }, [data]);

      const meses = useMemo(() => Array.from({ length: maxMes }, (_, i) => i + 1), [maxMes]);

      return (
        <div className="max-w-7xl mx-auto p-6 space-y-6">
          <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h1 className="text-2xl font-semibold">Matriz preliminar de riesgos agroclim√°ticos ¬∑ Cacao</h1>
              <p className="text-sm text-gray-600">Los meses representan <b>fases del ciclo</b>.</p>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={onBack} className="px-3 py-2 border rounded-lg text-sm">‚Üê Volver</button>
              <label className="text-sm text-gray-600">Fase:</label>
              <select
                value={fase}
                onChange={e => setFase(e.target.value)}
                className="border rounded-lg px-3 py-2 text-sm"
              >
                <option>Vegetativa</option>
                <option>Productiva</option>
              </select>
            </div>
          </header>

          <div className="overflow-auto border rounded-2xl">
            <table className="min-w-full text-sm">
              <thead>
                <tr className="bg-gray-50">
                  <th className="text-left px-3 py-2 sticky left-0 bg-gray-50 z-10">Elemento expuesto</th>
                  {meses.map(m => <th key={m} className="px-3 py-2 text-center border-l">M{m}</th>)}
                </tr>
              </thead>
              <tbody>
                {data.map((row, i) => {
                  const activo = (m, r) =>
                    Array.isArray(r?.meses) && r.meses.length
                      ? r.meses.includes(m)
                      : (typeof r.ini === "number" && typeof r.fin === "number" && m >= r.ini && m <= r.fin);
                  return (
                    <tr key={i} className={i % 2 ? "bg-white" : "bg-gray-50/50 hover:bg-emerald-50"}>
                      <td className="px-3 py-2 sticky left-0 bg-inherit max-w-[360px]">
                        <button onClick={() => setSel(row)} className="text-left hover:underline">
                          {row.elem}
                        </button>
                      </td>
                      {meses.map((m, j) => (
                        <td key={j} className={`h-9 border-l ${activo(m, row) ? "bg-emerald-200" : ""}`} />
                      ))}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <section className="text-xs text-gray-600">
            <div className="flex items-center gap-2">
              <Pill>D√©ficit h√≠drico</Pill>
              <Pill>Exceso h√≠drico</Pill>
              <Pill>Temperatura m√°xima</Pill>
              <Pill>Temperatura m√≠nima</Pill>
            </div>
            <p className="mt-2">Haz clic en el nombre de la fila para ver el detalle y las referencias.</p>
          </section>

          <PanelDetalle fila={sel} onClose={() => setSel(null)} />
        </div>
      );
    }

    // ===========================
    // APP PRINCIPAL
    // ===========================
    function App() {
      const { veg, prod } = useCsvData();
      const [paso, setPaso] = useState("intro");

      if (paso === "matriz" && ((veg?.length ?? 0) === 0 && (prod?.length ?? 0) === 0)) {
        return <div className="p-6 text-center text-gray-500">Cargando datos‚Ä¶</div>;
      }

      return paso === "intro"
        ? <Intro onStart={() => setPaso("matriz")} />
        : <MatrizCacao onBack={() => setPaso("intro")} dataVeg={veg} dataProd={prod} />;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
