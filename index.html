<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Applet FTA</title>

  <!-- PapaParse para leer CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-white text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // =========================================================
    //  FICHAS T√âCNICAS AGROCLIM√ÅTICAS // CATALOGOS 
    // =========================================================
    const CATALOGO = [
      {
        id: "cacao",
        nombre: "Cacao",
        tipo: "Perenne",
        fases: ["Vegetativa", "Productiva"],
        csv: {
          Vegetativa: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/vegetativa2.csv",
          Productiva: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/productiva.csv",
        },
        imagen: "assets/Dise√±oFTA.png",
      },
      {
        id: "maiz-eje-cafetero",
        nombre: "Ma√≠z ¬∑ Eje Cafetero",
        tipo: "Ciclo corto",
        fases: ["Vegetativa"], // fase √∫nica
        csv: {
          Vegetativa: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/maiz_eje_cafetero.csv",
        },
        imagen: "assets/Dise√±oFTA.png",
      },
      {
        id: "capsicum",
        nombre: "Capsicum (aj√≠/piment√≥n)",
        tipo: "Ciclo corto",
        variedades: {
          "Cayenne ¬∑ Palmira": {
            nombre: "Cayenne ¬∑ Palmira",
            fases: ["Unica"],
            csv: {
              Unica: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/Cayenne_Palmira.csv"
            }
          },
          "Habanero ¬∑ Palmira": {
            nombre: "Habanero ¬∑ Palmira",
            fases: ["Unica"],
            csv: {
              Unica: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/Habanero_Palmira.csv"
            }
          },
          "Tabasco ¬∑ Palmira": {
            nombre: "Tabasco ¬∑ Palmira",
            fases: ["Unica"],
            csv: {
              Unica: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/Tabasco_Palmira.csv"
            }
          },
        },
        imagen: "assets/Dise√±oFTA.png",
      },
      { id: "aguacate", nombre: "Aguacate", tipo: "Perenne", fases: ["Vegetativa", "Productiva"], csv: {}, comingSoon: true },
      { id: "zanahoria", nombre: "Zanahoria", tipo: "Ciclo corto", fases: ["Unica"], csv: {}, comingSoon: true },
    ];

    // =========================================================
    // LEER CSV CON VARIEDAD SI APLICA
    // =========================================================
    function useCsvData(entry, variedadKey) {
      const [veg, setVeg] = useState([]);
      const [prod, setProd] = useState([]);

      useEffect(() => {
        setVeg([]); setProd([]);
        if (!entry || entry.comingSoon) return;
        const fuente = entry.variedades
          ? (entry.variedades[variedadKey] || Object.values(entry.variedades)[0])
          : entry;
        if (!fuente) return;
        const normalizar = (rows) =>
          rows.filter(r => r.elem && r.elem.trim()).map(r => {
            const meses = (r.meses || "")
              .replace(/[\[\]\s]/g, "")
              .split(",")
              .filter(Boolean)
              .map(n => Number(n));
            return {
              elem: r.elem?.trim() || "",
              ini: r.ini ? Number(r.ini) : null,
              fin: r.fin ? Number(r.fin) : null,
              meses,
              riesgos: {
                deficit: r.deficit || "",
                exceso:  r.exceso  || "",
                Tmax:    r.Tmax    || "",
                Tmin:    r.Tmin    || "",
              },
              ref: r.ref || "",
            };
          });
        const cargar = (url, set) => {
          if (!url) return;
          Papa.parse(url, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: ({ data }) => set(normalizar(data)),
          });
        };
        if (fuente.fases?.includes("Vegetativa")) cargar(fuente.csv?.Vegetativa, setVeg);
        if (fuente.fases?.includes("Productiva")) cargar(fuente.csv?.Productiva, setProd);
        if (fuente.fases?.includes("Unica"))      cargar(fuente.csv?.Unica,       setVeg);
      }, [entry, variedadKey]);
      return { veg, prod };
    }

    // =========================================================
    // INTRODUCCI√ìN
    // =========================================================
    function Intro({ onStart, onTaller }) {
      return (
        <div className="max-w-5xl mx-auto p-6">
          <h1 className="text-3xl font-semibold mb-10 text-center">
            ¬øQU√â ES UNA FICHA T√âCNICA AGROCLIM√ÅTICA (FTA)?
          </h1>
          <p className="text-gray-700 mb-10">
            Una FTA es un instrumento <b>t√©cnico</b> que organiza y sintetiza los principales <b>riesgos agroclim√°ticos</b> que afectan un sistema productivo agr√≠cola.
            Para ello, se identifican los <b>elementos expuestos</b> del cultivo (ra√≠ces, tallo, floraci√≥n, pr√°cticas de manejo) y los relacionan con
            <b> amenazas clim√°ticas</b> como <i>d√©ficit y exceso h√≠drico</i> y <i>temperaturas extremas</i>.
          </p>
          <section className="grid md:grid-cols-2 gap-6 mb-10">
            <div className="rounded-2xl border p-5">
              <h2 className="font-semibold mb-2">Componentes de la FTA</h2>
              <ul className="list-disc ml-6 text-gray-700 space-y-1">
                <li>Filas = <b>elementos expuestos</b> (fases fenol√≥gicas o pr√°cticas agr√≠colas)</li>
                <li>Columnas = <b>ventana de temporalidad</b> y <b>amenazas clim√°ticas</b></li>
              </ul>
            </div>
            <div className="rounded-2xl border p-5">
              <h2 className="font-semibold mb-2">P√∫blico objetivo</h2>
              <p className="text-gray-700">
                Actores del territorio que tienen conocimiento directo, t√©cnico o pr√°ctico sobre los sistemas productivos priorizados.
              </p>
            </div>
          </section>
          <div className="p-4 rounded-xl bg-amber-50 text-amber-900 mb-10">
            <b>Importante:</b> Los campos <i>Mes inicio</i> y <i>Mes fin</i> <b>no son meses de calendario</b>.
          </div>
          <p className="text-gray-700 mb-12">
            Esta forma relativa de representar la temporalidad permite adaptar la ficha a ciclos productivos variables.
          </p>
          <div className="mb-12 flex justify-center">
            <img src="assets/Dise√±oFTA.png" alt="Dise√±o de la FTA" className="rounded-xl shadow-lg max-w-3xl w-full" />
          </div>
          <div className="flex justify-center gap-4">
            <button onClick={onStart} className="px-5 py-3 rounded-xl bg-emerald-600 text-white">üëâ Explorar fichas t√©cnicas</button>
            <button onClick={onTaller} className="px-5 py-3 rounded-xl bg-blue-600 text-white">üõ† Taller de cocreaci√≥n</button>
          </div>
        </div>
      );
    }

    // =========================================================
    // TALLER DE COCREACI√ìN
    // =========================================================
    function TallerCocreacion({ onBack }) {
      const fases = [
        { id: "M1", nombre: "Preparaci√≥n del terreno", mes: "Octubre", riesgos: ["Compactaci√≥n", "Exceso de humedad"], practicas: ["Labranza m√≠nima", "Aplicaci√≥n de enmiendas"], icono: "üå±" },
        { id: "M2", nombre: "Siembra", mes: "Nov-Dic", riesgos: ["Lluvias excesivas", "Sequ√≠a al inicio"], practicas: ["Selecci√≥n de semilla", "Densidad adecuada"], icono: "üåæ" },
        { id: "M3", nombre: "Emergencia", mes: "Dic-Ene", riesgos: ["D√©ficit h√≠drico", "Bajas temperaturas"], practicas: ["Riego de apoyo", "Control de arvenses"], icono: "üåø" },
        { id: "M7", nombre: "Cosecha", mes: "Abr-May", riesgos: ["Exceso de humedad", "Altas temperaturas"], practicas: ["Cosecha escalonada", "Almacenamiento adecuado"], icono: "üß∫" }
      ];
      return (
        <div className="max-w-6xl mx-auto p-6 space-y-10">
          <div className="flex items-center justify-between">
            <h1 className="text-2xl font-semibold">Taller de cocreaci√≥n de Fichas Agroclim√°ticas</h1>
            <button onClick={onBack} className="px-3 py-2 border rounded-lg text-sm">‚Üê Volver</button>
          </div>
          <p className="text-gray-600">Analiza el ciclo de tu cultivo, identifica fases clave, sus meses y los riesgos clim√°ticos asociados.</p>
          <div className="flex items-center justify-center gap-10">
            {fases.map((f, idx) => (
              <div key={f.id} className="flex flex-col items-center">
                <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl ${idx === 1 ? "bg-emerald-200 ring-4 ring-emerald-400" : "bg-gray-100"}`}>{f.icono}</div>
                <span className="mt-2 text-sm font-medium">{f.id}: {f.nombre}</span>
              </div>
            ))}
          </div>
          <div className="grid md:grid-cols-2 gap-6">
            {fases.map(f => (
              <div key={f.id} className="rounded-2xl border shadow-sm p-5">
                <h2 className="text-lg font-semibold mb-2">{f.nombre}</h2>
                <p className="text-sm text-gray-500 mb-3">Mes clave: {f.mes}</p>
                <b>Riesgos Clim√°ticos:</b>
                <ul className="list-disc ml-5 text-sm text-gray-700">{f.riesgos.map((r,i)=><li key={i}>{r}</li>)}</ul>
                <b className="block mt-3">Pr√°cticas de Manejo:</b>
                <ul className="list-disc ml-5 text-sm text-gray-700">{f.practicas.map((p,i)=><li key={i}>{p}</li>)}</ul>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // =========================================================
    // (Mantengo tus funciones SelectorFichas, PanelDetalle, Matriz igual que base)
    // =========================================================
    // ... aqu√≠ mantienes tal cual tu SelectorFichas, PanelDetalle y Matriz del c√≥digo base ...

    // =========================================================
    // APP 
    // =========================================================
    function App() {
      const [paso, setPaso] = useState("intro");
      const [entry, setEntry] = useState(null);
      const [variedadKey, setVariedadKey] = useState(null);
      const { veg, prod } = useCsvData(entry, variedadKey);

      if (paso === "intro") {
        return <Intro onStart={() => setPaso("selector")} onTaller={() => setPaso("taller")} />;
      }
      if (paso === "selector") {
        return <SelectorFichas onBack={() => setPaso("intro")} onPick={(it)=>{ setEntry(it); if(it.variedades){ setVariedadKey(Object.keys(it.variedades)[0]); } else { setVariedadKey(null); } setPaso("matriz"); }} />;
      }
      if (paso === "taller") {
        return <TallerCocreacion onBack={() => setPaso("intro")} />;
      }
      return <Matriz onBack={() => setPaso("selector")} entry={entry} veg={veg} prod={prod} variedadKey={variedadKey} setVariedadKey={setVariedadKey} />;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>

