<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Applet FTA</title>

  <!-- PapaParse para leer CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-white text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // =========================================================
    //  FICHAS T√âCNICAS AGROCLIM√ÅTICAS // CATALOGOS 
    // =========================================================
    const CATALOGO = [
      {
        id: "cacao",
        nombre: "Cacao",
        tipo: "Perenne",
        fases: ["Vegetativa", "Productiva"],
        csv: {
          Vegetativa: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/vegetativa2.csv",
          Productiva: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/productiva.csv",
        },
        imagen: "assets/Dise√±oFTA.png",
      },
      {
        id: "maiz-eje-cafetero",
        nombre: "Ma√≠z ¬∑ Eje Cafetero",
        tipo: "Ciclo corto",
        fases: ["Vegetativa"], // fase √∫nica
        csv: {
          Vegetativa: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/maiz_eje_cafetero.csv",
        },
        imagen: "assets/Dise√±oFTA.png",
      },

      // === NUEVO: capsicum con variedades ===
      {
        id: "capsicum",
        nombre: "Capsicum (aj√≠/piment√≥n)",
        tipo: "Ciclo corto",
        variedades: {
          "Cayenne ¬∑ Palmira": {
            nombre: "Cayenne ¬∑ Palmira",
            fases: ["Unica"],
            csv: {
              Unica: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/Cayenne_Palmira.csv"
            }
          },
          "Habanero ¬∑ Palmira": {
            nombre: "Habanero ¬∑ Palmira",
            fases: ["Unica"],
            csv: {
              Unica: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/Habanero_Palmira.csv"
            }
          },
          "Tabasco ¬∑ Palmira": {
            nombre: "Tabasco ¬∑ Palmira",
            fases: ["Unica"],
            csv: {
              Unica: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/Tabasco_Palmira.csv"
            }
          },
        },
        imagen: "assets/Dise√±oFTA.png",
      },

      // Otros (placeholder)
      { id: "aguacate", nombre: "Aguacate", tipo: "Perenne", fases: ["Vegetativa", "Productiva"], csv: {}, comingSoon: true },
      { id: "zanahoria", nombre: "Zanahoria", tipo: "Ciclo corto", fases: ["Unica"], csv: {}, comingSoon: true },
    ];

    // =========================================================
    // LEER CSV CON VARIEDAD SI APLICA
    // =========================================================
    function useCsvData(entry, variedadKey) {
      const [veg, setVeg] = useState([]);
      const [prod, setProd] = useState([]);

      useEffect(() => {
        setVeg([]); setProd([]);
        if (!entry || entry.comingSoon) return;

        const fuente = entry.variedades
          ? (entry.variedades[variedadKey] || Object.values(entry.variedades)[0])
          : entry;

        if (!fuente) return;

        const normalizar = (rows) =>
          rows
            .filter(r => r.elem && r.elem.trim())
            .map(r => {
              const meses = (r.meses || "")
                .replace(/[\[\]\s]/g, "")
                .split(",")
                .filter(Boolean)
                .map(n => Number(n));
              return {
                elem: r.elem?.trim() || "",
                ini: r.ini ? Number(r.ini) : null,
                fin: r.fin ? Number(r.fin) : null,
                meses,
                riesgos: {
                  deficit: r.deficit || "",
                  exceso:  r.exceso  || "",
                  Tmax:    r.Tmax    || "",
                  Tmin:    r.Tmin    || "",
                },
                ref: r.ref || "",
              };
            });

        const cargar = (url, set) => {
          if (!url) return;
          Papa.parse(url, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: ({ data }) => set(normalizar(data)),
          });
        };

        if (fuente.fases?.includes("Vegetativa")) cargar(fuente.csv?.Vegetativa, setVeg);
        if (fuente.fases?.includes("Productiva")) cargar(fuente.csv?.Productiva, setProd);
        if (fuente.fases?.includes("Unica"))      cargar(fuente.csv?.Unica,       setVeg);
      }, [entry, variedadKey]);

      return { veg, prod };
    }

    // =========================================================
    // INTRODUCCI√ìN
    // =========================================================
    function Intro({ onStart, onTaller }) {
      return (
        <div className="max-w-5xl mx-auto p-6">
          <h1 className="text-3xl font-semibold mb-10 text-center">
            ¬øQU√â ES UNA FICHA T√âCNICA AGROCLIM√ÅTICA (FTA)?
          </h1>

          <p className="text-gray-700 mb-10">
            Una FTA es un instrumento <b>t√©cnico</b> que organiza y sintetiza los principales <b>riesgos agroclim√°ticos</b> que afectan un sistema productivo agr√≠cola.
            Para ello, se identifican los <b>elementos expuestos</b> del cultivo (ra√≠ces, tallo, floraci√≥n, pr√°cticas de manejo) y los relacionan con
            <b> amenazas clim√°ticas</b> como <i>d√©ficit y exceso h√≠drico</i> y <i>temperaturas extremas</i>. Este instrumento permite la toma de decisiones oportunas y <b>adaptativas</b>
            por parte de los actores del sistema productivo con el fin de fortalecer la planificaci√≥n agr√≠cola.
          </p>

          {/* Botones */}
          <div className="flex justify-center gap-4">
            <button
              onClick={onStart}
              className="px-5 py-3 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700"
            >
              üëâ Explorar fichas t√©cnicas
            </button>
            <button
              onClick={onTaller}
              className="px-5 py-3 rounded-xl bg-blue-600 text-white font-medium hover:bg-blue-700"
            >
              üõ† Taller de cocreaci√≥n
            </button>
          </div>
        </div>
      );
    }

    // =========================================================
    // NUEVO COMPONENTE: TALLER DE COCREACI√ìN
    // =========================================================
    function TallerCocreacion({ onBack }) {
      const fases = [
        { id: 1, nombre: "Preparaci√≥n del terreno" },
        { id: 2, nombre: "Siembra" },
        { id: 3, nombre: "Emergencia" },
        { id: 4, nombre: "Floraci√≥n" },
        { id: 5, nombre: "Cosecha" },
      ];

      return (
        <div className="max-w-5xl mx-auto p-6 space-y-10">
          <div className="flex items-center justify-between">
            <h1 className="text-2xl font-semibold">Taller de cocreaci√≥n de Fichas Agroclim√°ticas</h1>
            <button onClick={onBack} className="px-3 py-2 border rounded-lg text-sm">‚Üê Volver</button>
          </div>

          <p className="text-gray-600">
            Analiza el ciclo de tu cultivo, identifica fases clave, sus meses y los riesgos clim√°ticos asociados.
          </p>

          {/* L√≠nea temporal */}
          <div className="flex items-center justify-between relative">
            {fases.map((f, i) => (
              <div key={f.id} className="flex flex-col items-center w-1/5">
                <div className="w-12 h-12 rounded-full bg-emerald-600 text-white flex items-center justify-center mb-2">
                  M{f.id}
                </div>
                <span className="text-sm text-center">{f.nombre}</span>
              </div>
            ))}
            <div className="absolute top-6 left-0 right-0 h-1 bg-emerald-300 -z-10"></div>
          </div>
        </div>
      );
    }

    // =========================================================
    // APP
    // =========================================================
    function App() {
      const [paso, setPaso] = useState("intro");
      const [entry, setEntry] = useState(null);
      const [variedadKey, setVariedadKey] = useState(null);

      const { veg, prod } = useCsvData(entry, variedadKey);

      if (paso === "intro") {
        return <Intro onStart={() => setPaso("selector")} onTaller={() => setPaso("taller")} />;
      }

      if (paso === "taller") {
        return <TallerCocreacion onBack={() => setPaso("intro")} />;
      }

      if (paso === "selector") {
        return (
          <SelectorFichas
            onBack={() => setPaso("intro")}
            onPick={(it) => {
              setEntry(it);
              if (it.variedades) {
                const firstKey = Object.keys(it.variedades)[0];
                setVariedadKey(firstKey);
              } else {
                setVariedadKey(null);
              }
              setPaso("matriz");
            }}
          />
        );
      }

      if (!entry) {
        return <div className="p-6 text-center text-gray-500">Selecciona un sistema productivo‚Ä¶</div>;
      }
      if (entry.comingSoon) {
        return (
          <div className="max-w-xl mx-auto p-6 text-center space-y-4">
            <button onClick={() => setPaso("selector")} className="px-3 py-2 border rounded-lg text-sm">‚Üê Volver</button>
            <p className="text-gray-600">Esta ficha a√∫n no est√° disponible.</p>
          </div>
        );
      }

      const fuente = entry.variedades
        ? (entry.variedades[variedadKey] || Object.values(entry.variedades)[0])
        : entry;

      const esperando =
        (fuente?.fases?.includes("Vegetativa") && veg.length === 0) ||
        (fuente?.fases?.includes("Productiva") && prod.length === 0) ||
        (fuente?.fases?.includes("Unica") && veg.length === 0);

      if (esperando) {
        return <div className="p-6 text-center text-gray-500">Cargando datos‚Ä¶</div>;
      }

      return (
        <Matriz
          onBack={() => setPaso("selector")}
          entry={entry}
          veg={veg}
          prod={prod}
          variedadKey={variedadKey}
          setVariedadKey={setVariedadKey}
        />
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
