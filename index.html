<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Applet FTA (corregido1)</title>

  <!-- PapaParse para leer CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-white text-gray-800">
    <header class="p-4 flex items-center bg-white shadow-sm">
        <img src="https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/assets/Logo_Agrorac.png" 
         alt="Logo AGRORAC" 
         class="h-12 w-auto mr-3" />
        <span class="text-xl font-semibold text-emerald-700">AGRORAC</span>
    </header>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // =========================================================
    //  FICHAS T√âCNICAS AGROCLIM√ÅTICAS // CATALOGOS 
    // =========================================================
    const CATALOGO = [
      {
        id: "cacao",
        nombre: "Cacao",
        tipo: "Perenne",
        fases: ["Vegetativa", "Productiva"],
        csv: {
          Vegetativa: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/vegetativa2.csv",
          Productiva: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/productiva.csv",
        },
        imagen: "assets/Dise√±oFTA.png",
      },
      {
        id: "maiz-eje-cafetero",
        nombre: "Ma√≠z ¬∑ Eje Cafetero",
        tipo: "Ciclo corto",
        fases: ["Vegetativa"], // fase √∫nica
        csv: {
          Vegetativa: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/maiz_eje_cafetero.csv",
        },
        imagen: "assets/Dise√±oFTA.png",
      },

      // === NUEVO: capsicum con variedades ===
      {
        id: "capsicum",
        nombre: "Capsicum (aj√≠/piment√≥n)",
        tipo: "Ciclo corto",
        // Las variedades definen sus propias fases y CSV
        variedades: {
          "Cayenne ¬∑ Palmira": {
            nombre: "Cayenne ¬∑ Palmira",
            fases: ["Unica"],
            csv: {
              Unica: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/Cayenne_Palmira.csv"
            }
          },
          "Habanero ¬∑ Palmira": {
            nombre: "Habanero ¬∑ Palmira",
            fases: ["Unica"],
            csv: {
              Unica: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/Habanero_Palmira.csv"
            }
          },
          "Tabasco ¬∑ Palmira": {
            nombre: "Tabasco ¬∑ Palmira",
            fases: ["Unica"],
            csv: {
              Unica: "https://raw.githubusercontent.com/vvalencia1306-code/applet-FTA/main/Tabasco_Palmira.csv"
            }
          },
        },
        imagen: "assets/Dise√±oFTA.png",
      },

      // Otros (placeholder)
      { id: "aguacate", nombre: "Aguacate", tipo: "Perenne", fases: ["Vegetativa", "Productiva"], csv: {}, comingSoon: true },
      { id: "zanahoria", nombre: "Zanahoria", tipo: "Ciclo corto", fases: ["Unica"], csv: {}, comingSoon: true },
    ];

    // =========================================================
    // LEER CSV CON VARIEDAD SI APLICA
    // =========================================================
    function useCsvData(entry, variedadKey) {
      const [veg, setVeg] = useState([]);
      const [prod, setProd] = useState([]);

      useEffect(() => {
        setVeg([]); setProd([]);
        if (!entry || entry.comingSoon) return;

        // Si el cultivo tiene "variedades", usa la variedad elegida; si no, usa el propio entry.
        const fuente = entry.variedades
          ? (entry.variedades[variedadKey] || Object.values(entry.variedades)[0])
          : entry;

        if (!fuente) return;

        const normalizar = (rows) =>
          rows
            .filter(r => r.elem && r.elem.trim())
            .map(r => {
              const meses = (r.meses || "")
                .replace(/[\[\]\s]/g, "")
                .split(",")
                .filter(Boolean)
                .map(n => Number(n));
              return {
                elem: r.elem?.trim() || "",
                ini: r.ini ? Number(r.ini) : null,
                fin: r.fin ? Number(r.fin) : null,
                meses,
                riesgos: {
                  deficit: r.deficit || "",
                  exceso:  r.exceso  || "",
                  Tmax:    r.Tmax    || "",
                  Tmin:    r.Tmin    || "",
                },
                ref: r.ref || "",
              };
            });

        const cargar = (url, set) => {
          if (!url) return;
          Papa.parse(url, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: ({ data }) => set(normalizar(data)),
          });
        };

        // Soporta Vegetativa / Productiva / Unica
        if (fuente.fases?.includes("Vegetativa")) cargar(fuente.csv?.Vegetativa, setVeg);
        if (fuente.fases?.includes("Productiva")) cargar(fuente.csv?.Productiva, setProd);
        if (fuente.fases?.includes("Unica"))      cargar(fuente.csv?.Unica,       setVeg);
      }, [entry, variedadKey]);

      return { veg, prod };
    }

    // =========================================================
    // INTRODUCCI√ìN
    // =========================================================
    function Intro({ onStart, onTaller }) {
      return (
        <div className="max-w-5xl mx-auto p-6">
          <h1 className="text-3xl font-semibold mb-10 text-center">
            ¬øQU√â ES UNA FICHA T√âCNICA AGROCLIM√ÅTICA (FTA)?
          </h1>

          {/* 1) P√°rrafo inicial */}
          <p className="text-gray-700 mb-10">
            Una FTA es un instrumento <b>t√©cnico</b> que organiza y sintetiza los principales <b>riesgos agroclim√°ticos</b> que afectan un sistema productivo agr√≠cola.
            Para ello, se identifican los <b>elementos expuestos</b> del cultivo (ra√≠ces, tallo, floraci√≥n, pr√°cticas de manejo) y los relacionan con
            <b> amenazas clim√°ticas</b> como <i>d√©ficit y exceso h√≠drico</i> y <i>temperaturas extremas</i>. Este instrumento permite la toma de decisiones oportunas y <b>adaptativas</b>
            por parte de los actores del sistema productivo con el fin de fortalecer la planificaci√≥n agr√≠cola.
          </p>

          {/* 2) DOS CUADROS */}
          <section className="grid md:grid-cols-2 gap-6 mb-10">
            <div className="rounded-2xl border p-5">
              <h2 className="font-semibold mb-2">Componentes de la FTA</h2>
              <ul className="list-disc ml-6 text-gray-700 space-y-1">
                <li>
                  Filas ={" "}
                  <span className="relative group cursor-help inline-block">
                    <b>elementos expuestos</b>
                    <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-64 p-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg">
                      Componentes del cultivo susceptibles a los riesgos clim√°ticos, como ra√≠ces, tallo, hojas o pr√°cticas agr√≠colas.
                    </span>
                  </span>{" "}
                  (fases fenol√≥gicas o pr√°cticas agr√≠colas)
                </li>
                <li>
                  Columnas ={" "}
                  <span className="relative group cursor-help inline-block">
                    <b>ventana de temporalidad</b>
                    <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-64 p-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg">
                      Intervalos de tiempo dentro del ciclo productivo en los que se presentan riesgos clim√°ticos.
                    </span>
                  </span>{" "}
                  y{" "}
                  <span className="relative group cursor-help inline-block">
                    <b>amenazas clim√°ticas</b>
                    <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-64 p-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg">
                      Condiciones como d√©ficit h√≠drico, exceso h√≠drico y temperaturas extremas que afectan al cultivo.
                    </span>
                  </span>
                </li>
              </ul>
            </div>

            <div className="rounded-2xl border p-5">
              <h2 className="font-semibold mb-2">P√∫blico objetivo</h2>
              <p className="text-gray-700">
                Actores del territorio que tienen conocimiento directo, t√©cnico o pr√°ctico sobre los sistemas productivos priorizados.
                Su prop√≥sito es validar, complementar o ajustar las FTA preliminares y facilitar su apropiaci√≥n local.
              </p>
            </div>
          </section>

          {/* 3) RECUADRO AMARILLO + 4) P√ÅRRAFO largo (MOVIDOS ABAJO) */}
          <div className="p-4 rounded-xl bg-amber-50 text-amber-900 mb-10">
            <b>Importante:</b> Los campos <i>Mes inicio</i> y <i>Mes fin</i> <b>no son meses de calendario</b>.
            ‚ÄúMes 1‚Äù es el primer mes del evento dentro del sistema productivo. Por ejemplo, puede coincidir con octubre si all√≠ inicia la preparaci√≥n del terreno.
          </div>

          <p className="text-gray-700 mb-12">
            Esta forma relativa de representar la temporalidad permite adaptar la ficha a ciclos productivos variables, evitando rigideces en fechas hist√≥ricas de siembra o manejo.
            As√≠, la FTA se convierte en una herramienta flexible y √∫til frente a la variabilidad y el cambio clim√°tico, facilitando su contextualizaci√≥n territorial.
          </p>

          {/* 5) Imagen */}
          <div className="mb-12 flex justify-center">
            <img
              src="assets/Dise√±oFTA.png"
              alt="Dise√±o de la FTA"
              className="rounded-xl shadow-lg max-w-3xl w-full"
            />
          </div>

          {/* 6) Bot√≥n */}
          <div className="flex justify-center gap-4">
            <button
              onClick={onStart}
              className="px-5 py-3 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700"
            >
              üëâ Explorar fichas t√©cnicas
            </button>
            <button onClick={onTaller} className="px-5 py-3 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700"
            >
              üõ† Taller de cocreaci√≥n FTA 
            </button>
          </div>
        </div>
      );
    }

    // =========================================================
    // TALLER DE COCREACI√ìN
    // =========================================================
    function TallerCocreacion({ onBack }) {
      // Ahora la secuencia completa M1..M7 con fases adicionales solicitadas
      const fases = [
        { id: "M1", nombre: "Preparaci√≥n del terreno", mes: "Octubre", riesgos: ["Compactaci√≥n", "Exceso de humedad"], icono: "üå±" },
        { id: "M2", nombre: "Siembra", mes: "Noviembre", riesgos: ["Lluvias excesivas", "Sequ√≠a al inicio"], icono: "üåæ" },
        { id: "M3-M4", nombre: "Emergencia", mes: "Diciembre-Enero", riesgos: ["D√©ficit h√≠drico", "Bajas temperaturas"], icono: "üåø" },
        { id: "M5 y M7", nombre: "Plagas y enfermedades", mes: "Febrero y Abril", riesgos: ["Plagas", "Pat√≥genos"], icono: "üêõ" },
        { id: "M6", nombre: "Floraci√≥n", mes: "Marzo", riesgos: ["Heladas", "Estr√©s t√©rmico"], icono: "üå∏" },
        { id: "M7", nombre: "Desarrollo del fruto", mes: "Abril", riesgos: ["Ca√≠da de fruto", "Plagas del fruto"], icono: "üçä" },
        { id: "M10", nombre: "Cosecha", mes: "Julio", riesgos: ["Exceso de humedad", "Altas temperaturas"], icono: "üß∫" }
      ];
      // Resalta temporalmente el cuadro objetivo y hace scroll hacia √©l
      const highlight = (id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.add('ring-4', 'ring-emerald-300', 'ring-offset-2');
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        setTimeout(() => {
          el.classList.remove('ring-4', 'ring-emerald-300', 'ring-offset-2');
        }, 1200);
      };
      // Fotos de taller: lista y estado para lightbox modal (index)
      const fotosTaller = ['foto1.JPEG', 'foto2.JPEG', 'foto3.JPEG', 'foto4.JPEG'];
      const [selectedIndex, setSelectedIndex] = useState(null);

      // Manejo de teclas para el lightbox (Esc, ‚Üê, ‚Üí)
      useEffect(() => {
        if (selectedIndex === null) return;
        const onKey = (e) => {
          if (e.key === 'Escape') setSelectedIndex(null);
          if (e.key === 'ArrowLeft') setSelectedIndex((selectedIndex - 1 + fotosTaller.length) % fotosTaller.length);
          if (e.key === 'ArrowRight') setSelectedIndex((selectedIndex + 1) % fotosTaller.length);
        };
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [selectedIndex]);
      return (
        <div className="max-w-6xl mx-auto p-6 space-y-10">
          <div className="flex items-center justify-between">
            <h1 className="text-2xl font-semibold">Taller de codise√±o de Fichas T√©cnicas Agroclim√°ticas</h1>
            <button onClick={onBack} className="px-3 py-2 border rounded-lg text-sm">‚Üê Volver</button>
          </div>
          <p className="text-gray-600">Espacio participativo donde se construyen las FTA, integrando saberes t√©cnicos y locales con el fin de afinar os principales elementos expuestos del cultivo, los riesgos asociados a las amenazas clim√°ticas</p>
          <div className="relative z-20 flex items-center justify-between w-full px-8 mt-10 mb-6">
            {/* Paso cards encima de la l√≠nea roja ‚Äî alineadas con la fila de iconos */}
            <div className="flex flex-col items-center border border-gray-400 rounded-2xl p-6 shadow-md w-48 hover:scale-105 transition-transform bg-white">
              <span className="text-5xl">üìä</span>
              <p className="text-center font-semibold text-gray-700 mt-3">Construir<br/>l√≠nea de tiempo (FTA)</p>
            </div>
            

            <span className="text-4xl text-gray-600 hidden md:block">‚ûù</span>

            <div className="flex flex-col items-center border border-gray-400 rounded-2xl p-6 shadow-md w-48 hover:scale-105 transition-transform bg-white">
              <span className="text-5xl">üå±</span>
              <p className="text-center font-semibold text-gray-700 mt-3">Identificar<br/>elementos expuestos</p>
            </div>
            

            <span className="text-4xl text-gray-600 hidden md:block">‚ûù</span>

            <div className="flex flex-col items-center border border-gray-400 rounded-2xl p-6 shadow-md w-48 hover:scale-105 transition-transform bg-white">
              <span className="text-5xl">üå¶Ô∏è</span>
              <p className="text-center font-semibold text-gray-700 mt-3">Relacionar fases<br/>con riesgos clim√°ticos</p>
            </div>
          </div>

          <div className="relative">
            {/* L√≠nea ondulada de temporalidad (SVG) - queda detr√°s de los iconos */}
            <svg className="absolute left-0 right-0 top-[30%] -translate-y-1/2 w-full h-20 pointer-events-none z-10" viewBox="0 0 1000 100" preserveAspectRatio="none" aria-hidden>
              <path d="M0 60 C200 40 400 80 600 60 C750 50 850 70 1000 60" fill="none" stroke="#ef4444" strokeWidth="6" strokeLinecap="round" strokeLinejoin="round" opacity="0.95" />
            </svg>

            <div className="relative z-0 flex items-center justify-between w-full px-8 mt-38 translate-y-10">
              {fases.map((f, idx) => (
                <div key={f.id} className="flex flex-col items-center min-w-[64px]">
                  <div
                    role="button"
                    tabIndex={0}
                    onClick={() => highlight(`fase-${f.id}`)}
                    onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); highlight(`fase-${f.id}`); } }}
                    className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl cursor-pointer ${idx === 1 ? "bg-emerald-200 ring-4 ring-emerald-400" : "bg-gray-100"}`}
                  >{f.icono}</div>
                  <button
                    onClick={() => highlight(`fase-${f.id}`)}
                    className="mt-2 text-sm font-medium text-center max-w-[100px] text-gray-800 hover:underline"
                    aria-label={`Ir a ${f.nombre}`}
                  >{f.id}: {f.nombre}</button>
                </div>
              ))}
            </div>
          </div>
          <div className="grid md:grid-cols-2 gap-6 mt-74">
            {fases.map(f => (
              <div id={`fase-${f.id}`} key={f.id} className="rounded-2xl border shadow-sm p-5">
                <h2 className="text-lg font-semibold mb-2">{f.nombre}</h2>
                <p className="text-sm text-gray-500 mb-3">Mes clave: {f.mes}</p>
                <b>Riesgos Agroclim√°ticos:</b>
                <ul className="list-disc ml-5 text-sm text-gray-700">{f.riesgos.map((r,i)=><li key={i}>{r}</li>)}</ul>
              </div>
            ))}
          </div>

          {/* Galer√≠a de talleres (usa assets/foto1.JPEG .. foto4.JPEG) */}
          <div className="mt-8">
            <h3 className="text-lg font-semibold mb-4">Galer√≠a de talleres</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {fotosTaller.map((fichero, i) => (
                <img
                  key={i}
                  src={`assets/${fichero}`}
                  alt={`Foto taller ${i+1}`}
                  loading="lazy"
                  onClick={() => setSelectedIndex(i)}
                  className="w-full h-36 md:h-28 object-cover rounded-xl shadow-md hover:scale-105 transition-transform cursor-pointer"
                />
              ))}
            </div>
            {/* Lightbox modal con prev/next y navegaci√≥n por teclado */}
            {selectedIndex !== null && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50" onClick={() => setSelectedIndex(null)}>
                <div className="max-w-3xl w-[90%] p-4" onClick={(e) => e.stopPropagation()}>
                  <div className="flex items-center justify-between mb-2 gap-2">
                    <button className="text-white bg-black/30 px-3 py-1 rounded" onClick={() => setSelectedIndex(null)}>Cerrar ‚úï</button>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setSelectedIndex((selectedIndex - 1 + fotosTaller.length) % fotosTaller.length)}
                        className="text-white bg-black/30 px-3 py-1 rounded"
                        aria-label="Foto anterior"
                      >‚Üê</button>
                      <button
                        onClick={() => setSelectedIndex((selectedIndex + 1) % fotosTaller.length)}
                        className="text-white bg-black/30 px-3 py-1 rounded"
                        aria-label="Foto siguiente"
                      >‚Üí</button>
                    </div>
                  </div>
                  <img src={`assets/${fotosTaller[selectedIndex]}`} alt={`Foto ampliada ${selectedIndex+1}`} className="w-full h-auto rounded-lg shadow-lg" />
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // =========================================================
    // SELECCIONAR LAS FICHAS T√âCNICAS AGROCLIM√ÅTICAS //OJO IMPORTANTE ESTABLECER EL TIPO (PERENNE O CICLO CORTO)
    // =========================================================
   function SelectorFichas({ onBack, onPick }) {
  const [tab, setTab] = useState("Perenne");

  // Filtra por tipolog√≠a (normalizando may√∫sculas/min√∫sculas y espacios)
  const items = useMemo(() => {
    const t = (tab || "").toLowerCase().trim();
    return CATALOGO.filter(c => (c.tipo || "").toLowerCase().trim() === t);
  }, [tab]);

  return (
    <div className="max-w-6xl mx-auto p-6 space-y-6">
      <div className="flex items-center justify-between">
        <button onClick={onBack} className="px-3 py-2 border rounded-lg text-sm">‚Üê Volver</button>
        <div className="flex gap-2">
          <button
            className={`px-3 py-2 rounded-lg border text-sm ${tab === "Perenne" ? "bg-gray-900 text-white" : ""}`}
            onClick={() => setTab("Perenne")}
          >
            Perennes
          </button>
          <button
            className={`px-3 py-2 rounded-lg border text-sm ${tab === "Ciclo corto" ? "bg-gray-900 text-white" : ""}`}
            onClick={() => setTab("Ciclo corto")}
          >
            Ciclo corto
          </button>
        </div>
      </div>

      <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-5">
        {items.map((it) => (
          <div
            key={it.id}
            className={`rounded-2xl border p-5 shadow-sm ${it.comingSoon ? "opacity-60" : "hover:shadow-md"}`}
          >
            <div className="flex items-center justify-between mb-2">
              <h3 className="font-semibold">{it.nombre}</h3>
              {it.comingSoon && (
                <span className="text-xs bg-gray-100 border px-2 py-1 rounded-full">Pr√≥ximamente</span>
              )}
            </div>
            <p className="text-sm text-gray-600 mb-4">Tipo: {it.tipo}</p>
            <button
              disabled={!!it.comingSoon}
              onClick={() => onPick(it)}
              className={`px-3 py-2 rounded-lg text-sm ${
                it.comingSoon ? "bg-gray-100 text-gray-400 border" : "bg-emerald-600 hover:bg-emerald-700 text-white"
              }`}
            >
              Ver ficha
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}

    // =========================================================
    // PANEL DETALLE (sin cambios)
    // =========================================================
    function PanelDetalle({ fila, onClose }) {
      if (!fila) return null;
      const R = fila.riesgos || {};
      return (
        <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 flex">
          <div className="m-auto w-[95%] max-w-3xl bg-white rounded-2xl shadow-lg p-5">
            <div className="flex items-start justify-between gap-4">
              <h3 className="text-lg font-semibold">{fila.elem}</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <p className="text-sm text-gray-600 mb-3">
              {fila.meses?.length
                ? <>Meses: {fila.meses.map(m => `M${m}`).join(", ")}</>
                : <>Ventana: M{fila.ini ?? "‚Äî"} ‚Äì M{fila.fin ?? "‚Äî"}</>}
            </p>
            <div className="grid md:grid-cols-2 gap-3 text-sm">
              <div className="border rounded-xl p-3"><b>D√©ficit h√≠drico:</b> {R.deficit || "‚Äî"}</div>
              <div className="border rounded-xl p-3"><b>Exceso h√≠drico:</b> {R.exceso || "‚Äî"}</div>
              <div className="border rounded-xl p-3"><b>Temperatura m√°xima:</b> {R.Tmax || "‚Äî"}</div>
              <div className="border rounded-xl p-3"><b>Temperatura m√≠nima:</b> {R.Tmin || "‚Äî"}</div>
            </div>
            <p className="text-xs text-gray-500 mt-4"><b>Referencias:</b> {fila.ref || "‚Äî"}</p>
          </div>
        </div>
      );
    }
    // =========================================================
    // MATRIZ ‚Äî SELECTOR DE VARIEDAD EN CASO DE QUE SEA (POR EJEMPLO CAPSICUM ESTAMOS TRABAJANDO CON TRES CAYYENE-TABASCO-HABANERO)
    // =========================================================
    function Matriz({ onBack, entry, veg, prod, variedadKey, setVariedadKey }) {
      const variedades = entry?.variedades || null;
      const fuente = variedades
        ? (variedades[variedadKey] || Object.values(variedades)[0])
        : entry;

      const hasTwoPhases = fuente?.fases?.includes("Vegetativa") && fuente?.fases?.includes("Productiva");
      const [fase, setFase] = useState(hasTwoPhases ? "Vegetativa" : "Unica");
      const [sel, setSel] = useState(null);

      // Si cambia la variedad (o entrada), re-sincroniza la fase inicial
      useEffect(() => {
        setFase(hasTwoPhases ? "Vegetativa" : "Unica");
        setSel(null);
      }, [entry, variedadKey]);

      const data = hasTwoPhases
        ? (fase === "Productiva" ? prod : veg)
        : (veg?.length ? veg : prod);

      const maxMes = useMemo(() => {
        const filaMax = (r) =>
          Array.isArray(r?.meses) && r.meses.length ? Math.max(...r.meses) :
          (typeof r?.fin === "number" ? r.fin : 0);
        const vals = (data || []).map(filaMax);
        const max = vals.length ? Math.max(...vals) : 0;
        return max > 0 ? max : 22;
      }, [data]);

      const meses = useMemo(() => Array.from({ length: maxMes }, (_, i) => i + 1), [maxMes]);

      // T√≠tulo con nombre del cultivo y, si aplica, de la variedad
      const titulo = variedades
        ? `${entry?.nombre} ¬∑ ${variedades[variedadKey]?.nombre || ""}`
        : entry?.nombre || "";

      return (
        <div className="max-w-7xl mx-auto p-6 space-y-6">
          <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h1 className="text-2xl font-semibold">Matriz preliminar de riesgos agroclim√°ticos ¬∑ {titulo}</h1>
              <p className="text-sm text-gray-600">Los meses representan <b>fases del ciclo</b>.</p>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={onBack} className="px-3 py-2 border rounded-lg text-sm">‚Üê Volver</button>

              {variedades && (
                <>
                  <label className="text-sm text-gray-600">Variedad:</label>
                  <select
                    value={variedadKey}
                    onChange={e => setVariedadKey(e.target.value)}
                    className="border rounded-lg px-3 py-2 text-sm"
                  >
                    {Object.entries(variedades).map(([key, v]) => (
                      <option key={key} value={key}>{v.nombre}</option>
                    ))}
                  </select>
                </>
              )}

              {hasTwoPhases && (
                <>
                  <label className="text-sm text-gray-600">Fase:</label>
                  <select
                    value={fase}
                    onChange={e => setFase(e.target.value)}
                    className="border rounded-lg px-3 py-2 text-sm"
                  >
                    <option>Vegetativa</option>
                    <option>Productiva</option>
                  </select>
                </>
              )}
            </div>
          </header>

          <div className="overflow-auto border rounded-2xl">
            <table className="min-w-full text-sm">
              <thead>
                <tr className="bg-gray-50">
                  <th className="text-left px-3 py-2 sticky left-0 bg-gray-50 z-10">Elemento expuesto</th>
                  {meses.map(m => <th key={m} className="px-3 py-2 text-center border-l">M{m}</th>)}
                </tr>
              </thead>
              <tbody>
                {(data || []).map((row, i) => {
                  const activo = (m, r) => {
                    if (Array.isArray(r?.meses) && r.meses.length) return r.meses.includes(m);
                    return typeof r.ini === "number" && typeof r.fin === "number" && m >= r.ini && m <= r.fin;
                  };
                  return (
                    <tr key={i} className={i % 2 ? "bg-white" : "bg-gray-50/50 hover:bg-emerald-50"}>
                      <td className="px-3 py-2 sticky left-0 bg-inherit max-w-[360px]">
                        <button onClick={() => setSel(row)} className="text-left hover:underline">
                          {row.elem}
                        </button>
                      </td>
                      {meses.map((m, j) => (
                        <td key={j} className={`h-9 border-l ${activo(m, row) ? "bg-emerald-200" : ""}`} />
                      ))}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <PanelDetalle fila={sel} onClose={() => setSel(null)} />
        </div>
      );
    }

    // =========================================================
    // SELECTOR DE MATRIZ 
    // =========================================================
    function App() {
      const [paso, setPaso] = useState("intro");     // "intro" | "selector" | "matriz" | "taller"
      const [entry, setEntry] = useState(null);      // cultivo seleccionado
      const [variedadKey, setVariedadKey] = useState(null); // clave de variedad (si aplica)

      const { veg, prod } = useCsvData(entry, variedadKey);

      if (paso === "intro") {
        return <Intro onStart={() => setPaso("selector")} onTaller={() => setPaso("taller")} />;
      }

      if (paso === "taller") {
        return <TallerCocreacion onBack={() => setPaso("intro")} />;
      }

      if (paso === "selector") {
        return (
          <SelectorFichas
            onBack={() => setPaso("intro")}
            onPick={(it) => {
              setEntry(it);
              if (it.variedades) {
                const firstKey = Object.keys(it.variedades)[0];
                setVariedadKey(firstKey);
              } else {
                setVariedadKey(null);
              }
              setPaso("matriz");
            }}
          />
        );
      }

      // Paso "matriz"
      if (!entry) {
        return <div className="p-6 text-center text-gray-500">Selecciona un sistema productivo‚Ä¶</div>;
      }
      if (entry.comingSoon) {
        return (
          <div className="max-w-xl mx-auto p-6 text-center space-y-4">
            <button onClick={() => setPaso("selector")} className="px-3 py-2 border rounded-lg text-sm">‚Üê Volver</button>
            <p className="text-gray-600">Esta ficha a√∫n no est√° disponible.</p>
          </div>
        );
      }

      // Esperando carga CSV (seg√∫n fases de la fuente actual)
      const fuente = entry.variedades
        ? (entry.variedades[variedadKey] || Object.values(entry.variedades)[0])
        : entry;

      const esperando =
        (fuente?.fases?.includes("Vegetativa") && veg.length === 0) ||
        (fuente?.fases?.includes("Productiva") && prod.length === 0) ||
        (fuente?.fases?.includes("Unica")      && veg.length === 0);

      if (esperando) {
        return <div className="p-6 text-center text-gray-500">Cargando datos‚Ä¶</div>;
      }

      return (
        <Matriz
          onBack={() => setPaso("selector")}
          entry={entry}
          veg={veg}
          prod={prod}
          variedadKey={variedadKey}
          setVariedadKey={setVariedadKey}
        />
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
